![image](https://github.com/user-attachments/assets/1432d378-a37c-423e-9b64-349b1d087c09)
# Ansible Cheat Sheet
[Ansible Cheat Sheet](https://github.com/magnum31415/wiki/blob/main/Ansible_Cheat_Sheet.pdf)

# Instalar venv ansible

Installing the core Ansible toolset involves relatively few steps and has minimal requirements. On the other hand, installing the additional components that Red Hat Ansible Automation Platform provides, such as the automation controller (formerly called Red Hat Ansible Tower), requires a Red Hat Enterprise Linux 8.2 or later system, with a minimum of two CPUs, 4 GiB of RAM, and 20 GiB of available disk space. 

• You need a valid Red Hat Ansible Automation Platform subscription to install the core toolset on your control node. 
````
subscription-manager register 
subscription-manager repos --enable ansible-2-for-rhel-8-x86_64-rpms 
yum install ansible 
ansible --version 
ansible -m setup localhost | grep ansible_python_version

````


## Instalar en un venv
```
python3 -m venv ansible_2.17
source ansible_2.17/bin/activate
pip install ansible-core==2.17
pip install pywinrm
```


## Proxychains

```
sudo apt-get install proxychains
vim /etc/proxychains.conf 

Add in [ProxyList]
socks5 12.34.11.123 1080
```

# Commandos 
```
proxychains ansible-playbook -i ../inventario.ini -l SERVERNAMEO01 playbook.yml --vault-password-file ../vault_pass.txt
```

```
ansible -i ../inventario.ini server01 -m setup -a 'filter=ansible_fqdn' 
ansible -i ../inventario.ini server01 -m setup -a 'filter=ansible_hostname' 
```

```
ansible '*.example.com, !*.lab.example.com'  -i inventory1 --list-hosts 
ansible  lb1.lab.example.com,s1.lab.example.com,db1.example.com -i inventory1  --list-hosts 
ansible '172.25.*' -i inventory1 --list-hosts 
ansible 's*' -i inventory1 --list-hosts 
ansible 'prod,172*,*lab*' -i inventory1  --list-hosts 
ansible 'db,&london' -i inventory1  --list-hosts 
```

# ansible.cfg

ANSIBLE_CONFIG environment variable overrides all other configuration files. If that variable is not set, the directory in which the ansible command was run is then checked for an ansible.cfg file. If that file is not present, the user's home directory is checked for a .ansible.cfg file. The global /etc/ansible/ansible.cfg file is only used if no other configuration file is found. If the /etc/ansible/ansible.cfg configuration file is not present, Ansible contains defaults which it uses. 
 
 to clearly identify which version of Ansible is installed, and which configuration file is being used. 
 ```
[user@controlnode ~]$ ansible --version 
ansible 2.9.21 
config file = /etc/ansible/ansible.cfg 
 
[user@controlnode ~]$ ansible servers --list-hosts -v 
Using /etc/ansible/ansible.cfg as config file 
```

ansible.cfg
````
[defaults] 
inventory = ./inventory 
remote_user = user 
ask_pass = false 
 
[privilege_escalation] 
become = true 
become_method = sudo 
become_user = root 
become_ask_pass = false ![image](https://github.com/user-attachments/assets/4d437060-6474-4b0a-9e05-492271e9bff1)

````

##If you want to find out what options are available in the configuration file, use the 
 ````
 ansible-config list 
 ````
##you might want to find out which options have been set to values which are different from the built-in defaults. 
````
ansible-config dump -v --only-changed ![image](https://github.com/user-attachments/assets/eba4aa69-d6d1-411f-b217-6aca8119995a)
````

# ansible-doc

-  the -s option, which produces example output that can serve as a model for how to use a particular module in a playbook.
-  to see a list of the modules available on a control node, run the ansible-doc -l

# Inventory

An inventory defines a collection of hosts that Ansible will manage. These hosts can also be assigned to groups, which can be managed collectively. Groups can contain child groups, and hosts can be members of multiple groups. The inventory can also set variables that apply to the hosts and groups that it defines. 
Host inventories can be defined in two different ways. A static host inventory can be defined by a text file. A dynamic host inventory can be generated by a script or other program as needed, using external information providers. 

Ansible host inventories can include groups of host groups. This is accomplished by creating a host group name with the :children suffix.  

````
[usa] 
washington[1:2].example.com 
 
[canada] 
ontario01.example.com 
ontario02.example.com 
 
[north-america:children] 
canada 
usa 

````


## Verifying the Inventory 
ansible washington1.example.com --list-hosts 
ansible usa --list-hosts 
ansible all --list-hosts 
ansible ungrouped --list-hosts 
ansible host-or-group -i inventory --list-hosts ![image](https://github.com/user-attachments/assets/6c08ea69-cdbb-42dd-86a8-8d049f24fce4)

## Special groups

 - **all** that matches all managed hosts in the inventory. ![image](https://github.com/user-attachments/assets/ed6e7689-bc22-47eb-8892-946bb4d4bcd7)
````
 - hosts: all 
````
- **ungrouped**, which includes all managed hosts in the inventory that are not members of any other group: 
 - hosts: ungrouped 
````
- Another method of accomplishing the same thing as the all host pattern is to use the asterisk (*)
 - hosts: * 
````
- (&) matches machines in the lab group only if they are also in the datacenter1 group: 
````
- hosts: lab,&datacenter1
````
- Exclude hosts (!). Ex. all hosts defined in the datacenter group, except test2.example.com  
````
- hosts: datacenter,!test2.example.com
````


# Facts
 
````
ansible webservers -m setup 
````
FACTS filtrat x subset && fine-grained 
````
ansible webservers -m setup -a 'gather_subset=network filter=ansible_interfaces' 
````
several values 
```` 
ansible localhost -m setup -a 'filter=fqdn,hostname,*ipv*' 
````

Use the -o option to display the output of Ansible ad hoc commands in a single line format. 
````
ansible mymanagedhosts -m command -a /usr/bin/hostname -o 
````

#COMMANDS/MODULES 

## ansible-doc
The ansible-doc -l command lists all modules installed on a system. You can use ansible-doc to view the documentation of particular modules by name, and find information about what arguments the modules take as options. 
 ````
Ansible-doc ping 
 ````
The ansible-doc command also offers the -s option, which produces example output that can serve as a model for how to use a particular module in a playbook. 

## ad-hoc

````
ansible dev -m copy  -a 'content="Managed by Ansible\n" dest=/etc/motd' -b -u devops 
ansible localhost -m copy -a 'content="Managed by Ansible\n" dest=/etc/motd' -u devops --become 
ansible all -m copy  -a 'content="Managed by Ansible\n" dest=/etc/motd' -u devops --become 
 
 
 
## verify that the contents of the file 
ansible dev -m command -a "cat /etc/motd" 
ansible all -m command -a 'cat /etc/motd' -u devops 
 
ansible localhost -m command -a 'id' -u devops 
ansible -m user -a "name=newbie uid=4000 state=present"  servera.lab.example.com 
ansible servera.lab.example.com -m command  -a 'systemctl status httpd' 
ansible database_prod -m command  -a 'cat /etc/redhat-release' -u devops --become 
ansible all -m command -a 'ls -Z' -u devops 
ansible webservers -a  'systemctl is-active httpd' 
ansible webservers -a  'systemctl is-enabled httpd' 
ansible webservers -a  'cat /etc/httpd/conf.d/vhost.conf' 
ansible webservers -m uri  -a 'url=http://localhost return_content=true' 
ansible demohost -m ping 
ansible demohost -m ping --become 
ansible demohost -m command -a 'free -m' 
ansible servera.lab.example.com  -u devops -b -a "firewall-cmd --list-services" 
ansible all -m yum  -a 'name=example-motd state=absent' 
ansible dev -m copy  -a 'content="Managed by Ansible\n" dest=/etc/motd' -b -u devops 
ansible localhost -m copy  -a 'content="Managed by Ansible\n" dest=/etc/motd' -u devops --become 
````

## Galaxy

##Using ansible-galaxy, create the directory structure for the new ansible-vsftpd role 
ansible-galaxy init ansible-vsftpd 

# Secrets

````
ansible-playbook --syntax-check  --ask-vault-pass create_users.yml 
ansible-playbook --vault-password-file=vault-pass create_users.yml 

````

# Playbooks

## Verify Syntax
ansible-playbook --syntax-check playbook.yml 

## Dry-run
You can use the -C option to perform a dry run --check

ansible -m user -a "name=newbie uid=4000 state=present"  servera.lab.example.com 



--- 
- name: Configure important user consistently 
hosts: servera.lab.example.com 
tasks: 
- name: newbie exists with UID 4000 
user: 
name: newbie 
uid: 4000 
state: present 



# Estructuras de datos

## Listas

Lists, You have also seen lists written with the normal single-dash syntax: 
hosts: 
- servera 
- serverb 
- serverc 
Lists also have an inline format enclosed in square braces, as follows: 
hosts: [servera, serverb, serverc]


# Templates Jinja
A Jinja2 template is composed of multiple elements: data, variables, and expressions

- use {% EXPR %} for expressions or logic (for example, loops)
- user {{ EXPR }} are used for outputting the results of an expression or a variable to the end user.!
- Use {# COMMENT #} syntax to enclose comments

````
{# /etc/hosts line #} 
{{ ansible_facts[default_ipv4][address] }}    {{ ansible_facts[hostname]}}
````

To avoid having system administrators modify files deployed by Ansible.
Ansible managed" string set in the ansible_managed directive in ansible.cfg.

````

#{{ ansible_managed }} 
Port {{ ssh_port }} 
ListenAddress {{ ansible_facts[default_ipv4][address] }} 
HostKey /etc/ssh/ssh_host_rsa_key 
HostKey /etc/ssh/ssh_host_ecdsa_key 
````

## Variable filters

change the output format for template expressions

````
{{ output | to_json }} 
{{ output | to_yaml }}
````

## Loops

````
{% for user in users %} 
{{ user }} 
{% endfor %} 

 
{# for statement #} 
{% for myuser in users if not myuser == "root" %} 
User number {{ loop.index }} - {{ myuser }} 
{% endfor %} 
````

The loop.index variable expands to the index number that the loop is currently on.

````
{% for myhost in groups['myhosts'] %} 
{{ myhost }} 
{% endfor %} 


{% for host in groups['all'] %} 
{{ hostvars[host]['ansible_facts']['default_ipv4']['address'] }} {{ hostvars[host]['ansible_facts']['fqdn'] }} {{ hostvars[host]['ansible_facts']['hostname'] }} 
{% endfor %} 
````

# Galaxy

#You can list the currently installed system roles with the ansible-galaxy list command 
````
ansible-galaxy list 
- linux-system-roles.kdump, (unknown version) 
- linux-system-roles.network, (unknown version) 
- linux-system-roles.postfix, (unknown version) 
- linux-system-roles.selinux, (unknown version) 
- linux-system-roles.timesync, (unknown version) 
- rhel-system-roles.kdump, (unknown version) 
- rhel-system-roles.network, (unknown version) 
- rhel-system-roles.postfix, (unknown version) 
- rhel-system-roles.selinux, (unknown version) 
- rhel-system-roles.timesync, (unknown version)
````
 
Roles are located in the /usr/share/ansible/roles directory. A role beginning with linux-system-roles is a symlink to the matching rhel-system-roles role. 
 
Review the Role Variables section of the README.md file for the rhel-system-roles.network role. 
cat /usr/share/doc/rhel-system-roles/network/README.md 


# HANDLING TASK FAILURE
Ansible evaluates the return code of each task to determine whether the task succeeded or failed. Normally, when a task fails Ansible immediately aborts the rest of the play on that host, skipping all subsequent tasks. 

## ignore_errors

By default, if a task fails, the play is aborted. However, this behavior can be overridden by ignoring failed tasks. You can use the ignore_errors keyword 

````
- name: Latest version of notapkg is installed 
yum: 
name: notapkg 
state: latest 
ignore_errors: yes
````
## force_handlers
Normally when a task fails and the play aborts on that host, any handlers that had been notified by earlier tasks in the play will not run. If you set the force_handlers: yes keyword on the play, then notified handlers are called even if the play aborted because a later task failed. 
Remember that handlers are notified when a task reports a changed result but are not notified when it reports an ok or failed result.

````
--- 
- hosts: all 
force_handlers: yes 
tasks: 
- name: a task which always notifies its handler 
command: /bin/true 
notify: restart the database 
- name: a task which fails because the package doesn't exist 
yum: 
name: notapkg 
state: latest 
handlers: 
- name: restart the database 
service: 
name: mariadb 

state: restarted ![image](https://github.com/user-attachments/assets/00a7e12c-f7f9-456c-86d8-c3f0f016e891)

````

## failed_when
used with command modules that may successfully execute a command, but the command's output indicates a failure.

````
tasks: 
- name: Run user creation script 
shell: /usr/local/bin/create_users.sh 
register: command_result 
failed_when: "'Password missing' in command_result.stdout"
````

## fail

The fail module can also be used to force a task failure. The above scenario can alternatively be written as two tasks: 
````
tasks: 
- name: Run user creation script 
shell: /usr/local/bin/create_users.sh 
register: command_result 
ignore_errors: yes 
- name: Report script failure 
fail: 
msg: "The password is missing in the output" 
when: "'Password
 missing' in command_result.stdout"
````

# Blocks

locks are clauses that logically group tasks, and can be used to control how tasks are executed. For example, a task block can have a when keyword to apply a conditional to multiple tasks: 
````
- name: block example 
hosts: all 
tasks: 
- name: installing and configuring Yum versionlock plugin 
block: 
- name: package needed by yum 
yum: 
name: yum-plugin-versionlock 
state: present 
- name: lock version of tzdata 
lineinfile: 
dest: /etc/yum/pluginconf.d/versionlock.list 
line: tzdata-2016j-1 
state: present 
when: ansible_distribution == "RedHat" 
````

If any task in a block fails, tasks in its rescue block are executed in order to recover. After the tasks in the block clause run, as well as the tasks in the rescue clause if there was a failure, then tasks in the always clause run.

````
tasks: 
- name: Upgrade DB 
  block: 
  - name: upgrade the database 
    shell: 
      cmd: /usr/local/lib/upgrade-database
  rescue: 
  - name: revert the database upgrade 
    shell: 
      cmd: /usr/local/lib/revert-database 
  always: 
  - name: always restart the database 
    service: 
      name: mariadb 
      state: restarted 
````
 
The when condition on a block clause also applies to its rescue and always clauses if present. 

````
--- 
- name: Task Failure Exercise 
hosts: databases 
vars: 
web_package: http 
db_package: mariadb-server 
db_service: mariadb 
tasks: 
- name: Check local time 
  command: date 
  register: command_result 
  changed_when: false 
- name: Print local time 
  debug: 
    var: command_result.stdout 
- name: Attempt to set up a webserver 
  block: 
  - name: Install {{ web_package }} package 
    yum: 
      name: "{{ web_package }}" 
      state: present 
    failed_when: web_package == "httpd" 
  rescue: 
  - name: Install {{ db_package }} package 
    yum: 
      name: "{{ db_package }}" 
      state: present 
  always: 
  - name: Start {{ db_service }} service 
    service: 
      name: "{{ db_service }}" 
      state: started
````

